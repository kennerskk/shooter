<!DOCTYPE html>
<html>
<head>
  <title>Shooter Online</title>
  <style>
    #game { display:none; }
    canvas { background: #222; display:block; margin:0 auto; }
  </style>
</head>
<body>
  <div id="login">
    <input id="username" placeholder="ชื่อของคุณ" />
    <input id="room" placeholder="เลขห้อง" />
    <button onclick="joinRoom()">เข้าห้อง</button>
  </div>
  <div id="game">
    <canvas id="canvas" width="600" height="400"></canvas>
    <div>กดลูกศรเพื่อเดิน, Spacebar เพื่อยิง</div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let myId = null;
    let players = {};

    function joinRoom() {
      const username = document.getElementById('username').value;
      const room = document.getElementById('room').value;
      socket.emit('joinRoom', { username, room });
      document.getElementById('login').style.display = 'none';
      document.getElementById('game').style.display = 'block';
    }

    socket.on('players', data => {
      players = data;
      if (!myId) myId = socket.id;
    });

    // วาดเกม
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    function draw() {
      ctx.clearRect(0,0,600,400);
      Object.entries(players).forEach(([id, p]) => {
        ctx.fillStyle = p.alive ? (id === socket.id ? 'lime' : 'cyan') : 'gray';
        ctx.beginPath();
        ctx.arc(p.x, p.y, 15, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.font = '12px sans-serif';
        ctx.fillText(p.username, p.x-15, p.y-20);
      });
      requestAnimationFrame(draw);
    }
    draw();

    // ควบคุม
    document.addEventListener('keydown', e => {
      if (!players[socket.id] || !players[socket.id].alive) return;
      if (e.key === 'ArrowLeft') socket.emit('move', 'left');
      if (e.key === 'ArrowRight') socket.emit('move', 'right');
      if (e.key === 'ArrowUp') socket.emit('move', 'up');
      if (e.key === 'ArrowDown') socket.emit('move', 'down');
      if (e.code === 'Space') {
        // ยิงไปข้างหน้าตามตำแหน่งตัวเอง (ตัวอย่าง: ยิงตรงหน้า)
        const me = players[socket.id];
        socket.emit('shoot', { x: me.x, y: me.y - 20 });
      }
    });
  </script>
</body>
</html>